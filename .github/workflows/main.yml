name: 'Orquestrador Multicloud TCC (Azure & AWS)'

run-name: "${{ github.event.inputs.provider == 'azure' && 'üü¶' || 'üüß' }} ${{ github.event.inputs.action == 'apply' && 'Deploy' || 'Destroy' }} [${{ github.event.inputs.environment }}] por @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Selecione o Provedor de Nuvem'
        required: true
        type: choice
        options: [azure, aws]
      environment:
        description: 'Selecione o Ambiente'
        required: true
        type: choice
        options: [teste, homol, prod]
      action:
        description: 'A√ß√£o: apply ou destroy'
        required: true
        type: choice
        options: [apply, destroy]

env:
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: "us-east-1"

jobs:
  terraform_azure:
    name: "Terraform Azure | ${{ github.event.inputs.environment }}"
    runs-on: ubuntu-latest

    outputs:
      app_server_ips: ${{ steps.outputs.outputs.app_server_private_ips }}
      db_server_ip: ${{ steps.outputs.outputs.db_server_private_ip }}
      bastion_ip: ${{ steps.outputs.outputs.bastion_public_ip }}
      rg_name: "rg-tcc-${{ github.event.inputs.environment }}"

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      # --- AQUI EST√Å A CORRE√á√ÉO ---
      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3

      - name: 'Terraform Init'
        run: terraform init
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

      - name: 'Terraform Action'
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            terraform apply -auto-approve -var="create_environment=true"
          else
            terraform apply -auto-approve -var="create_environment=false"
          fi
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

      - name: 'Get Outputs'
        if: github.event.inputs.action == 'apply'
        id: outputs
        run: |
          echo "app_server_private_ips=$(terraform output -json app_server_private_ips)" >> $GITHUB_OUTPUT
          echo "db_server_private_ip=$(terraform output -raw db_server_private_ip)" >> $GITHUB_OUTPUT
          echo "bastion_public_ip=$(terraform output -raw bastion_public_ip)" >> $GITHUB_OUTPUT
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

  configure_azure_servers:
    name: 'Ansible Azure ‚öôÔ∏è'
    needs: terraform_azure
    runs-on: ubuntu-latest
    if: needs.terraform_azure.result == 'success' && github.event.inputs.action == 'apply'

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      # Corre√ß√£o tamb√©m aplicada no segundo job
      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: 'Abrir SSH no NSG do Bastion'
        run: |
          RUNNER_IP=$(curl -s ifconfig.me)
          NSG_NAME="nsg-bastion-${{ github.event.inputs.environment }}"
          RG_NAME="${{ needs.terraform_azure.outputs.rg_name }}"
          az network nsg rule create --resource-group $RG_NAME --nsg-name $NSG_NAME \
            --name AllowRunnerSSH --priority 110 --direction Inbound --access Allow \
            --protocol Tcp --source-address-prefixes $RUNNER_IP --source-port-ranges '*' \
            --destination-address-prefixes '*' --destination-port-ranges 22

      - name: 'Configurar com Ansible'
        run: |
          sudo apt-get update && sudo apt-get install -y ansible jq

          # 1. Prepara√ß√£o da pasta .ssh
          rm -rf /home/runner/.ssh
          mkdir -p /home/runner/.ssh
          chmod 700 /home/runner/.ssh

          # 2. Cria√ß√£o da chave RSA 4096
          echo "${{ secrets.TCC_ALISSON_AZURE_KEY }}" > /home/runner/.ssh/tcc-alisson-azure-rsa-key
          chmod 600 /home/runner/.ssh/tcc-alisson-azure-rsa-key

          BASTION_IP="${{ needs.terraform_azure.outputs.bastion_ip }}"
          APP_IP=$(echo '${{ needs.terraform_azure.outputs.app_server_ips }}' | jq -r '.[0]')

          echo "Aguardando 60 segundos para estabilidade do SSH e registro do DNS..."
          sleep 60

          # 3. Teste de Salto (AJUSTADO: Usu√°rio ubuntu)
          echo "Testando se o Bastion alcan√ßa a VM interna ($APP_IP)..."
          ssh -i /home/runner/.ssh/tcc-alisson-azure-rsa-key -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i /home/runner/.ssh/tcc-alisson-azure-rsa-key -o StrictHostKeyChecking=no -W %h:%p ubuntu@$BASTION_IP" \
            ubuntu@$APP_IP "echo 'Salto para VM interna OK!'" || echo "ALERTA: Conex√£o SSH falhou. Verifique se as VMs aceitaram o usu√°rio ubuntu."

          # 4. Gera√ß√£o do Invent√°rio
          echo "[app_servers]" > inventory.ini
          echo '${{ needs.terraform_azure.outputs.app_server_ips }}' | jq -r '.[]' | while read ip; do
            echo "app_server_${ip//./_} ansible_host=$ip" >> inventory.ini
          done

          cat <<EOF >> inventory.ini
          [db_servers]
          db-server ansible_host=${{ needs.terraform_azure.outputs.db_server_ip }}

          [all:vars]
          # AJUSTADO: Agora igual √† AWS
          ansible_user=ubuntu 
          ansible_ssh_private_key_file=/home/runner/.ssh/tcc-alisson-azure-rsa-key
          # AJUSTADO: ProxyCommand agora usa ubuntu@bastion
          ansible_ssh_common_args='-o StrictHostKeyChecking=no -o ProxyCommand="ssh -i /home/runner/.ssh/tcc-alisson-azure-rsa-key -o StrictHostKeyChecking=no -W %h:%p ubuntu@$BASTION_IP"'
          EOF
          
          # 5. Execu√ß√£o dos Playbooks
          ansible-playbook -i inventory.ini ../../../ansible/playbook_docker.yml -vvv
          ansible-playbook -i inventory.ini ../../../ansible/playbook_nginx_container.yml -e "environment_name=${{ github.event.inputs.environment }}" -vvv
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}