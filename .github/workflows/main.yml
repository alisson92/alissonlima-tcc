name: 'Orquestrador Multicloud TCC (Azure & AWS)'

run-name: "${{ github.event.inputs.provider == 'azure' && 'ðŸŸ¦' || 'ðŸŸ§' }} ${{ github.event.inputs.action }} ${{ github.event.inputs.provider }} [${{ github.event.inputs.environment }}] por @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Provedor de Nuvem'
        required: true
        type: choice
        options: [azure, aws]
      environment:
        description: 'Ambiente'
        required: true
        type: choice
        options: [teste, homol, prod]
      action:
        description: 'AÃ§Ã£o'
        required: true
        type: choice
        options: [apply, destroy, force-unlock]
      lock_id:
        description: 'Lock ID (NecessÃ¡rio apenas para force-unlock)'
        required: false

env:
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: "us-east-1"

jobs:
  # ==========================================
  # JOBS DA AZURE (JÃ¡ validados)
  # ==========================================
  terraform_azure:
    name: "Terraform Azure | ${{ github.event.inputs.environment }}"
    if: github.event.inputs.provider == 'azure'
    runs-on: ubuntu-latest

    outputs:
      app_server_ips: ${{ steps.outputs.outputs.app_server_private_ips }}
      db_server_ip: ${{ steps.outputs.outputs.db_server_private_ip }}
      bastion_ip: ${{ steps.outputs.outputs.bastion_public_ip }}
      rg_name: "rg-tcc-${{ github.event.inputs.environment }}"

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3

      - name: 'Terraform Init'
        run: terraform init
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

      - name: 'Terraform Action'
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            terraform apply -auto-approve -var="create_environment=true"
          elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            terraform apply -auto-approve -var="create_environment=false"
          else
            terraform force-unlock -force ${{ github.event.inputs.lock_id }}
          fi
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

      - name: 'Get Outputs'
        if: github.event.inputs.action == 'apply'
        id: outputs
        run: |
          echo "app_server_private_ips=$(terraform output -json app_server_private_ips)" >> $GITHUB_OUTPUT
          echo "db_server_private_ip=$(terraform output -raw db_server_private_ip)" >> $GITHUB_OUTPUT
          echo "bastion_public_ip=$(terraform output -raw bastion_public_ip)" >> $GITHUB_OUTPUT
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

  configure_azure_servers:
    name: 'Ansible Azure âš™ï¸'
    needs: terraform_azure
    if: github.event.inputs.provider == 'azure' && needs.terraform_azure.result == 'success' && github.event.inputs.action == 'apply'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: 'Abrir SSH no NSG (JIT)'
        run: |
          RUNNER_IP=$(curl -s ifconfig.me)
          az network nsg rule create --resource-group ${{ needs.terraform_azure.outputs.rg_name }} --nsg-name nsg-bastion-${{ github.event.inputs.environment }} \
            --name AllowRunnerSSH --priority 110 --direction Inbound --access Allow \
            --protocol Tcp --source-address-prefixes $RUNNER_IP --source-port-ranges '*' \
            --destination-address-prefixes '*' --destination-port-ranges 22

      - name: 'Configurar com Ansible'
        run: |
          sudo apt-get update && sudo apt-get install -y ansible jq
          mkdir -p ~/.ssh
          echo "${{ secrets.TCC_ALISSON_AZURE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          BASTION_IP="${{ needs.terraform_azure.outputs.bastion_ip }}"
          echo "[app_servers]" > inventory.ini
          echo '${{ needs.terraform_azure.outputs.app_server_ips }}' | jq -r '.[]' | while read ip; do echo "app_server_${ip//./_} ansible_host=$ip" >> inventory.ini; done
          cat <<EOF >> inventory.ini
          [db_servers]
          db-server ansible_host=${{ needs.terraform_azure.outputs.db_server_ip }}
          [all:vars]
          ansible_user=ubuntu
          ansible_ssh_private_key_file=~/.ssh/id_rsa
          ansible_ssh_common_args='-o StrictHostKeyChecking=no -o ProxyCommand="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -W %h:%p ubuntu@$BASTION_IP"'
          EOF
          ansible-playbook -i inventory.ini ../../../ansible/playbook_docker.yml -vvv
          ansible-playbook -i inventory.ini ../../../ansible/playbook_nginx_container.yml -e "environment_name=${{ github.event.inputs.environment }}" -vvv
        working-directory: ./environments/azure/${{ github.event.inputs.environment }}

      - name: 'Fechar SSH no NSG'
        if: always()
        run: az network nsg rule delete --resource-group ${{ needs.terraform_azure.outputs.rg_name }} --nsg-name nsg-bastion-${{ github.event.inputs.environment }} --name AllowRunnerSSH

  # ==========================================
  # JOBS DA AWS (Integrados com novo padrÃ£o)
  # ==========================================
  terraform_aws:
    name: "Terraform AWS | ${{ github.event.inputs.environment }}"
    if: github.event.inputs.provider == 'aws'
    runs-on: ubuntu-latest

    outputs:
      app_server_ips: ${{ steps.outputs.outputs.app_server_private_ips }}
      db_server_ip: ${{ steps.outputs.outputs.db_server_private_ip }}
      bastion_ip: ${{ steps.outputs.outputs.bastion_public_ip }}
      sg_bastion_id: ${{ steps.outputs.outputs.sg_bastion_id }}

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Configure AWS'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3

      - name: 'Terraform Init'
        run: terraform init
        working-directory: ./environments/aws/${{ github.event.inputs.environment }}

      - name: 'Terraform Action'
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            terraform apply -auto-approve -var="create_environment=true"
          elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            terraform apply -auto-approve -var="create_environment=false"
          else
            terraform force-unlock -force ${{ github.event.inputs.lock_id }}
          fi
        working-directory: ./environments/aws/${{ github.event.inputs.environment }}

      - name: 'Get Outputs'
        if: github.event.inputs.action == 'apply'
        id: outputs
        run: |
          echo "app_server_private_ips=$(terraform output -json app_server_private_ips)" >> $GITHUB_OUTPUT
          echo "db_server_private_ip=$(terraform output -raw db_server_private_ip)" >> $GITHUB_OUTPUT
          echo "bastion_public_ip=$(terraform output -raw bastion_public_ip)" >> $GITHUB_OUTPUT
          echo "sg_bastion_id=$(terraform output -raw sg_bastion_id)" >> $GITHUB_OUTPUT
        working-directory: ./environments/aws/${{ github.event.inputs.environment }}

  configure_aws_servers:
    name: 'Ansible AWS âš™ï¸'
    needs: terraform_aws
    if: github.event.inputs.provider == 'aws' && needs.terraform_aws.result == 'success' && github.event.inputs.action == 'apply'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Configure AWS'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: 'Abrir SSH no SG (JIT)'
        run: |
          RUNNER_IP=$(curl -s ifconfig.me)
          aws ec2 authorize-security-group-ingress --group-id ${{ needs.terraform_aws.outputs.sg_bastion_id }} --protocol tcp --port 22 --cidr ${RUNNER_IP}/32

      - name: 'Configurar com Ansible'
        run: |
          sudo apt-get update && sudo apt-get install -y ansible jq
          mkdir -p ~/.ssh
          echo "${{ secrets.TCC_ALISSON_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          BASTION_IP="${{ needs.terraform_aws.outputs.bastion_ip }}"
          echo "[app_servers]" > inventory.ini
          echo '${{ needs.terraform_aws.outputs.app_server_ips }}' | jq -r '.[]' | while read ip; do echo "app_server_${ip//./_} ansible_host=$ip" >> inventory.ini; done
          cat <<EOF >> inventory.ini
          [db_servers]
          db-server ansible_host=${{ needs.terraform_aws.outputs.db_server_ip }}
          [all:vars]
          ansible_user=ubuntu
          ansible_ssh_private_key_file=~/.ssh/id_rsa
          ansible_ssh_common_args='-o StrictHostKeyChecking=no -o ProxyCommand="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -W %h:%p ubuntu@$BASTION_IP"'
          EOF
          ansible-playbook -i inventory.ini ../../../ansible/playbook_docker.yml -vvv
          ansible-playbook -i inventory.ini ../../../ansible/playbook_nginx_container.yml -e "environment_name=${{ github.event.inputs.environment }}" -vvv
        working-directory: ./environments/aws/${{ github.event.inputs.environment }}
        
      - name: 'Fechar SSH no SG'
        if: always()
        run: |
          RUNNER_IP=$(curl -s ifconfig.me)
          aws ec2 revoke-security-group-ingress --group-id ${{ needs.terraform_aws.outputs.sg_bastion_id }} --protocol tcp --port 22 --cidr ${RUNNER_IP}/32